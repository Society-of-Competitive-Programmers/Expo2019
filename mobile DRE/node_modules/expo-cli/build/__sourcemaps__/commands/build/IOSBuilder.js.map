{"version":3,"sources":["commands/build/IOSBuilder.js"],"names":["nonEmptyInput","val","expertPrompt","produceAbsolutePath","p12Path","isAbsolute","resolve","runAsExpertQuestion","type","name","message","choices","value","OBLIGATORY_CREDS_KEYS","pushP12","pushPassword","provisioningProfile","teamId","OBLIGATORY_DIST_CERT_CREDS_KEYS","certP12","certPassword","LET_EXPO_HANDLE","I_PROVIDE_FILE","OVERRIDE_CHOICES","whatToOverride","provisionProfilePath","validate","doesFileProvidedExist","bind","filter","sharedQuestions","password","length","appleCredsQuestions","createChooseDistCertPrompt","IOSBuilder","publicUrl","options","buildOptions","getThirdPartyInfoAsync","getPublishInfoAsync","projectDir","args","username","experienceName","remoteFullPackageName","bundleIdentifier","bundleIdentifierIOS","sdkVersion","checkIfSdkIsSupported","INVALID_OPTIONS","checkStatus","platform","credentialMetadata","clearOnly","clearCredentials","distCert","appCredentials","clearAppCredentials","clearDistCert","isEmpty","removeCredentialsForPlatform","only","warn","prepareLocalAuth","runLocalAuth","error","DEBUG","stdout","undefined","replace","ensureReleaseExists","publishedExpIds","build","distP12Path","process","env","EXPO_IOS_DIST_P12_PASSWORD","pushP12Path","EXPO_IOS_PUSH_P12_PASSWORD","provisioningProfilePath","creds","readFile","toString","credentialsToAskFor","newCredentials","newMetadata","choice","userProvidedOverride","metadata","credentials","distCertValues","pathToP12","certP12Buffer","p12Password","distCertSerialNumber","findP12CertSerialNumber","_ensureObjectsHasOnlyStrings","pushCertValues","pathToProvisioningProfile","Error","obj","result","forEach","isString","k","appleCreds","credsMetadata","ensureAppIdLocally","checkAppExistenceAttempt","reason","startsWith","NO_BUNDLE_ID","createAppOnPortal","_throwIfFailureWithReasonDump","other","isEnterprise","produceProvisionProfile","produceProvisionProfileAttempt","MULTIPLE_PROFILES","APPLE_ERRORS","produceCerts","produceCertAttempt","producePushCerts","producePushCertsAttempt","appleCredentials","distOrPush","askWhichCertsToDump","revokeWhat","revokeCredentialsOnApple","revokeAttempt","revokeCount","f","_revokeHelper","revokeAppleDistCerts","revokeApplePushCerts","revokeAppleProvisioningProfile","setTimeout","r","revokeProvisioningProfile","msg","justTeamId","askForAppleCreds","validateCredentialsProduceTeamId","checkCredsAttempt","_handleRevokes","_ensureAppExists","team","teamName","credsMissing","includes","push","whatToOverrideFiltered","whatToOverrideResult","expoManages","_chooseDistCert","userCredentialId","serialNumber","toCopy","omit","spinner","start","intersection","text","expoManagedResource","stop","getExistingDistCerts","certs","map","certId","usedByApps","join","String","action","clientHas","obligatoryCreds","has","obligatoryKeys","keys","chain","uniq","getEncryptedCredentialsForPlatformAsync","credsStarter","clientHasAllNeededCreds","_areCredsMissing","checkEnv","runningAsCI","credentialsCI","updateCredentialsForPlatform","strategy","appleEnterpriseAccount","enterpriseAccount","_validateCredsEnsureAppExists","isExpoManaged","runningAsExpoManaged","runningAsExpert","withoutEncrypted","pickBy","v","replyAttempt","rawDump","appleId","EXPO_APPLE_PASSWORD","console","log"],"mappings":"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","file":"../../../commands/build/IOSBuilder.js","sourcesContent":["/**\n * @flow\n */\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport untildify from 'untildify';\nimport { Exp, Credentials, XDLError, ErrorCode, IosCodeSigning } from 'xdl';\nimport ora from 'ora';\nimport _ from 'lodash';\n\nimport BaseBuilder from './BaseBuilder';\nimport prompt from '../../prompt';\nimport log from '../../log';\n\nimport * as authFuncs from './auth';\n\nconst nonEmptyInput = val => val !== '';\n\nconst expertPrompt = `\nWARNING! In this mode, we won't be able to make sure your certificates,\nor provisioning profile are valid. Please double check that you're\nuploading valid files for your app otherwise you may encounter strange errors!\n\nMake sure you've created your app ID on the developer portal, that your app ID\nis in app.json as \\`bundleIdentifier\\`, and that the provisioning profile you\nupload matches that team ID and app ID.\n`;\n\nconst produceAbsolutePath = p12Path => {\n  p12Path = untildify(p12Path);\n  if (!path.isAbsolute(p12Path)) {\n    p12Path = path.resolve(p12Path);\n  }\n  return p12Path;\n};\n\nconst runAsExpertQuestion = {\n  type: 'list',\n  name: 'isExpoManaged',\n  message: 'How would you like to upload your credentials?\\n',\n  choices: [\n    { name: 'Expo handles all credentials, you can still provide overrides', value: true },\n    {\n      name: 'I will provide all the credentials and files needed, Expo does limited validation',\n      value: false,\n    },\n  ],\n};\n\nconst OBLIGATORY_CREDS_KEYS = {\n  pushP12: 'pushCert',\n  pushPassword: 'pushCert',\n  provisioningProfile: 'provisioningProfile',\n  teamId: 'teamId',\n};\n\nconst OBLIGATORY_DIST_CERT_CREDS_KEYS = {\n  certP12: 'distCert',\n  certPassword: 'distCert',\n};\n\nconst LET_EXPO_HANDLE = 'Let Expo handle the process';\n\nconst I_PROVIDE_FILE = 'I want to upload my own file';\n\nconst OVERRIDE_CHOICES = [\n  { name: LET_EXPO_HANDLE, value: true },\n  { name: I_PROVIDE_FILE, value: false },\n];\n\nconst whatToOverride = [\n  {\n    type: 'list',\n    name: 'distCert',\n    message: 'Will you provide your own Distribution Certificate?',\n    choices: OVERRIDE_CHOICES,\n  },\n  {\n    type: 'list',\n    name: 'pushCert',\n    message: 'Will you provide your own Push Certificate?',\n    choices: OVERRIDE_CHOICES,\n  },\n];\n\nconst provisionProfilePath = {\n  type: 'input',\n  name: 'pathToProvisioningProfile',\n  message: 'Path to your .mobile provisioning Profile',\n  validate: authFuncs.doesFileProvidedExist.bind(null, true),\n  filter: produceAbsolutePath,\n};\n\nconst sharedQuestions = [\n  {\n    type: 'input',\n    name: 'pathToP12',\n    message: 'Path to P12 file:',\n    validate: authFuncs.doesFileProvidedExist.bind(null, true),\n    filter: produceAbsolutePath,\n  },\n  {\n    type: 'password',\n    name: 'p12Password',\n    message: 'P12 password:',\n    validate: password => password.length > 0,\n  },\n];\n\nconst appleCredsQuestions = [\n  {\n    type: 'input',\n    name: 'appleId',\n    message: `What's your Apple ID?`,\n    validate: nonEmptyInput,\n  },\n  {\n    type: 'password',\n    name: 'password',\n    message: `Password?`,\n    validate: nonEmptyInput,\n  },\n];\n\nconst createChooseDistCertPrompt = choices => ({\n  type: 'list',\n  name: 'distCert',\n  message: 'Would you like to reuse Distribution Certificate from another app?',\n  choices,\n});\n\nexport default class IOSBuilder extends BaseBuilder {\n  async run() {\n    const publicUrl = this.options.publicUrl;\n    const buildOptions = {\n      ...(publicUrl ? { publicUrl } : {}),\n    };\n    // validate bundleIdentifier before hitting the network to check build status\n    const {\n      args: {\n        username,\n        remoteFullPackageName: experienceName,\n        bundleIdentifierIOS: bundleIdentifier,\n        sdkVersion,\n      },\n    } = publicUrl\n      ? await Exp.getThirdPartyInfoAsync(publicUrl)\n      : await Exp.getPublishInfoAsync(this.projectDir);\n\n    await this.checkIfSdkIsSupported(sdkVersion, 'ios');\n\n    if (!bundleIdentifier) {\n      throw new XDLError(\n        ErrorCode.INVALID_OPTIONS,\n        `Your project must have a bundleIdentifier set in app.json.\nSee https://docs.expo.io/versions/latest/guides/building-standalone-apps.html`\n      );\n    }\n\n    // Check the status of any current builds\n    await this.checkStatus({ platform: 'ios', sdkVersion, ...buildOptions });\n    const credentialMetadata = { username, experienceName, bundleIdentifier, platform: 'ios' };\n    const clearOnly = {};\n    if (this.options.clearCredentials) {\n      clearOnly.distCert = true;\n      clearOnly.appCredentials = true;\n    } else {\n      if (this.options.clearAppCredentials) {\n        clearOnly.appCredentials = true;\n      }\n      if (this.options.clearDistCert) {\n        clearOnly.distCert = true;\n      }\n    }\n    // Clear credentials if they want to:\n    if (!_.isEmpty(clearOnly)) {\n      await Credentials.removeCredentialsForPlatform('ios', {\n        ...credentialMetadata,\n        only: clearOnly,\n      });\n      log.warn('Removed existing credentials from expo servers');\n    }\n    if (this.options.type !== 'simulator') {\n      try {\n        await authFuncs.prepareLocalAuth();\n        await this.runLocalAuth(credentialMetadata);\n      } catch (e) {\n        log.error(`Error while gathering & validating credentials`);\n        if (authFuncs.DEBUG) {\n          if (e.stdout !== undefined) {\n            // sometimes WSL adds null characters\n            log.error(e.stdout.replace(/\\0/g, ''));\n          } else {\n            log.error(e);\n          }\n        }\n        throw e;\n      }\n    }\n    // Publish the experience, if necessary\n    const publishedExpIds = this.options.publicUrl\n      ? undefined\n      : await this.ensureReleaseExists('ios');\n    // Initiate the build with the published experience\n    await this.build(publishedExpIds, 'ios', { bundleIdentifier, ...buildOptions });\n  }\n\n  checkEnv() {\n    return (\n      this.options.teamId &&\n      this.options.distP12Path &&\n      process.env.EXPO_IOS_DIST_P12_PASSWORD &&\n      this.options.pushP12Path &&\n      process.env.EXPO_IOS_PUSH_P12_PASSWORD &&\n      this.options.provisioningProfilePath\n    );\n  }\n\n  async runningAsCI() {\n    const creds = {\n      teamId: this.options.teamId,\n      certP12: this.options.distP12Path,\n      certPassword: process.env.EXPO_IOS_DIST_P12_PASSWORD,\n      pushP12: this.options.pushP12Path,\n      pushPassword: process.env.EXPO_IOS_PUSH_P12_PASSWORD,\n      provisioningProfile: this.options.provisioningProfilePath,\n    };\n\n    return {\n      ...creds,\n      ...{\n        provisioningProfile: (await fs.readFile(creds.provisioningProfile)).toString('base64'),\n        certP12: (await fs.readFile(creds.certP12)).toString('base64'),\n        pushP12: (await fs.readFile(creds.pushP12)).toString('base64'),\n      },\n    };\n  }\n\n  async runningAsExpert(credentialsToAskFor = ['distCert', 'pushCert', 'provisioningProfile']) {\n    log(expertPrompt);\n    let newCredentials = {};\n    let newMetadata = {};\n    for (const choice of credentialsToAskFor) {\n      const { metadata, credentials } = await this.userProvidedOverride(choice);\n      newCredentials = { ...newCredentials, ...credentials };\n      newMetadata = { ...newMetadata, ...metadata };\n    }\n    return {\n      newCredentials,\n      newMetadata,\n    };\n  }\n\n  // End user wants to override these credentials, that is, they want\n  // to provide their own creds\n  async userProvidedOverride(choice) {\n    switch (choice) {\n      case 'distCert': {\n        log('Please provide your distribution certificate P12:');\n        const distCertValues = await prompt(sharedQuestions);\n        const certP12Buffer = await fs.readFile(distCertValues.pathToP12);\n        const certPassword = distCertValues.p12Password;\n        const distCertSerialNumber = IosCodeSigning.findP12CertSerialNumber(\n          certP12Buffer,\n          certPassword\n        );\n        return {\n          metadata: distCertSerialNumber,\n          credentials: this._ensureObjectsHasOnlyStrings({\n            certP12: certP12Buffer.toString('base64'),\n            certPassword,\n          }),\n        };\n      }\n      case 'pushCert': {\n        log('Please provide the path to your push notification cert P12');\n        const pushCertValues = await prompt(sharedQuestions);\n        return {\n          metadata: {},\n          credentials: this._ensureObjectsHasOnlyStrings({\n            pushP12: (await fs.readFile(pushCertValues.pathToP12)).toString('base64'),\n            pushPassword: pushCertValues.p12Password,\n          }),\n        };\n      }\n      case 'provisioningProfile': {\n        log('Please provide the path to your .mobile provisioning profile');\n        const { pathToProvisioningProfile } = await prompt(provisionProfilePath);\n        return {\n          metadata: {},\n          credentials: this._ensureObjectsHasOnlyStrings({\n            provisioningProfile: (await fs.readFile(pathToProvisioningProfile)).toString('base64'),\n          }),\n        };\n      }\n      default:\n        throw new Error(`Unknown choice to override: ${choice}`);\n    }\n  }\n\n  _ensureObjectsHasOnlyStrings(obj) {\n    const result = {};\n    Object.keys(obj).forEach(k => {\n      const isString = typeof obj[k] === 'string';\n      if (isString) {\n        result[k] = obj[k];\n      } else {\n        result[k] = JSON.stringify(obj[k]);\n      }\n    });\n    return result;\n  }\n\n  async _ensureAppExists(appleCreds, credsMetadata, teamId) {\n    let checkAppExistenceAttempt = await authFuncs.ensureAppIdLocally(\n      appleCreds,\n      credsMetadata,\n      teamId\n    );\n    if (\n      checkAppExistenceAttempt.result === 'failure' &&\n      checkAppExistenceAttempt.reason.startsWith(authFuncs.NO_BUNDLE_ID)\n    ) {\n      checkAppExistenceAttempt = await authFuncs.createAppOnPortal(\n        appleCreds,\n        credsMetadata,\n        teamId\n      );\n    }\n    this._throwIfFailureWithReasonDump(checkAppExistenceAttempt);\n    const { result, ...other } = checkAppExistenceAttempt;\n    return this._ensureObjectsHasOnlyStrings(other);\n  }\n\n  async produceProvisionProfile(appleCreds, credsMetadata, teamId, isEnterprise) {\n    const produceProvisionProfileAttempt = await authFuncs.produceProvisionProfile(\n      appleCreds,\n      credsMetadata,\n      teamId,\n      isEnterprise\n    );\n    if (\n      produceProvisionProfileAttempt.result === 'failure' &&\n      produceProvisionProfileAttempt.reason.startsWith(authFuncs.MULTIPLE_PROFILES)\n    ) {\n      log.warn(authFuncs.APPLE_ERRORS);\n    }\n    this._throwIfFailureWithReasonDump(produceProvisionProfileAttempt);\n    return this._ensureObjectsHasOnlyStrings(produceProvisionProfileAttempt);\n  }\n\n  async expoManagedResource(choice, appleCreds, teamId, credsMetadata, isEnterprise) {\n    switch (choice) {\n      case 'distCert': {\n        const produceCertAttempt = await authFuncs.produceCerts(appleCreds, teamId, isEnterprise);\n        this._throwIfFailureWithReasonDump(produceCertAttempt);\n        const distCertSerialNumber = IosCodeSigning.findP12CertSerialNumber(\n          produceCertAttempt.certP12,\n          produceCertAttempt.certPassword\n        );\n        return {\n          metadata: {\n            distCertSerialNumber,\n          },\n          credentials: this._ensureObjectsHasOnlyStrings(produceCertAttempt),\n        };\n      }\n      case 'pushCert': {\n        const producePushCertsAttempt = await authFuncs.producePushCerts(\n          appleCreds,\n          credsMetadata,\n          teamId,\n          isEnterprise\n        );\n        this._throwIfFailureWithReasonDump(producePushCertsAttempt);\n        return {\n          metadata: {},\n          credentials: this._ensureObjectsHasOnlyStrings(producePushCertsAttempt),\n        };\n      }\n      case 'provisioningProfile':\n        return {\n          metadata: {},\n          credentials: await this.produceProvisionProfile(\n            appleCreds,\n            credsMetadata,\n            teamId,\n            isEnterprise\n          ),\n        };\n      default:\n        throw new Error(`Unknown manage resource choice requested: ${choice}`);\n    }\n  }\n\n  async _revokeHelper(appleCredentials, credsMetadata, teamId, isEnterprise, distOrPush) {\n    // Get back IDs that Spaceship knows how to revoke\n    const revokeWhat = await authFuncs.askWhichCertsToDump(\n      appleCredentials,\n      credsMetadata,\n      teamId,\n      distOrPush,\n      isEnterprise\n    );\n    if (revokeWhat.length !== 0) {\n      const revokeAttempt = await authFuncs.revokeCredentialsOnApple(\n        appleCredentials,\n        credsMetadata,\n        revokeWhat,\n        teamId\n      );\n      if (revokeAttempt.result === 'success') {\n        log(`Revoked ${revokeAttempt.revokeCount} existing certs on developer.apple.com`);\n      } else {\n        log.warn(`Could not revoke certs: ${revokeAttempt.reason}`);\n      }\n    }\n  }\n\n  async _handleRevokes(appleCredentials, credsMetadata, teamId, isEnterprise) {\n    const f = this._revokeHelper.bind(null, appleCredentials, credsMetadata, teamId, isEnterprise);\n    if (this.options.revokeAppleDistCerts) {\n      log.warn('ATTENTION: Revoking your Apple Distribution Certificates is permanent');\n      await f('distCert');\n    }\n\n    if (this.options.revokeApplePushCerts) {\n      log.warn('ATTENTION: Revoking your Apple Push Certificates is permanent');\n      await f('pushCert');\n    }\n\n    if (this.options.revokeAppleProvisioningProfile) {\n      await new Promise(r => setTimeout(() => r(), 400));\n      log.warn(\n        `ATTENTION: Revoking your Apple Provisioning Profile for ${\n          credsMetadata.bundleIdentifier\n        } is permanent`\n      );\n      const revokeAttempt = await authFuncs.revokeProvisioningProfile(\n        appleCredentials,\n        credsMetadata,\n        teamId\n      );\n      if (revokeAttempt.result === 'success') {\n        log.warn(revokeAttempt.msg);\n      } else {\n        log.warn(\n          `Could not revoke provisioning profile: ${revokeAttempt.reason} rawDump:${JSON.stringify(\n            revokeAttempt\n          )}`\n        );\n      }\n    }\n  }\n\n  async _validateCredsEnsureAppExists(credsMetadata, justTeamId, isEnterprise) {\n    const appleCredentials = await this.askForAppleCreds(justTeamId);\n    log('Validating Credentials...');\n    const checkCredsAttempt = await authFuncs.validateCredentialsProduceTeamId(appleCredentials);\n    this._throwIfFailureWithReasonDump(checkCredsAttempt);\n    await this._handleRevokes(\n      appleCredentials,\n      credsMetadata,\n      checkCredsAttempt.teamId,\n      isEnterprise\n    );\n    await this._ensureAppExists(appleCredentials, credsMetadata, checkCredsAttempt.teamId);\n    return {\n      appleCredentials,\n      team: {\n        teamId: checkCredsAttempt.teamId,\n        teamName: checkCredsAttempt.teamName,\n      },\n    };\n  }\n\n  async runningAsExpoManaged(\n    appleCredentials,\n    teamId,\n    credsMetadata,\n    isEnterprise,\n    credsMissing = ['distCert', 'pushCert', 'provisioningProfile']\n  ) {\n    // (dsokal)\n    // This function and generally - IOSBuilder is unnecessarily overcomplicated.\n    // It would be good to refactor it some day, because changing anything here\n    // always takes me more time than I think it should.\n    //\n    // There are only two possible scenarios here:\n    //  - all of credentials are missing\n    //  - distribution certificate is missing (we have to regenerate provisioning profile)\n\n    if (_.includes(credsMissing, 'distCert') && !_.includes(credsMissing, 'provisioningProfile')) {\n      credsMissing.push('provisioningProfile');\n    }\n\n    const whatToOverrideFiltered = whatToOverride.filter(({ name }) =>\n      _.includes(credsMissing, name)\n    );\n    const whatToOverrideResult = await prompt(whatToOverrideFiltered);\n    const expoManages = { provisioningProfile: true };\n\n    const { userCredentialId, serialNumber } = whatToOverrideResult.distCert\n      ? await this._chooseDistCert(credsMetadata.username, teamId)\n      : {};\n\n    const toCopy = userCredentialId\n      ? _.omit(whatToOverrideResult, 'distCert')\n      : whatToOverrideResult;\n    Object.assign(expoManages, toCopy);\n\n    let newCredentials = {};\n    let newMetadata = {\n      ...credsMetadata,\n    };\n\n    if (userCredentialId) {\n      newCredentials.userCredentialId = userCredentialId;\n      newMetadata.distCertSerialNumber = serialNumber;\n    }\n\n    const spinner = ora('Running local authentication and producing required credentials').start();\n\n    const choices = _.intersection(credsMissing, Object.keys(expoManages));\n    try {\n      for (const choice of choices) {\n        spinner.text = `Now producing files for ${choice}`;\n        if (expoManages[choice]) {\n          spinner.start();\n          const { metadata, credentials } = await this.expoManagedResource(\n            choice,\n            appleCredentials,\n            teamId,\n            newMetadata,\n            isEnterprise\n          );\n          newMetadata = { ...newMetadata, ...metadata };\n          newCredentials = { ...newCredentials, ...credentials };\n        } else {\n          spinner.stop();\n          const { metadata, credentials } = await this.userProvidedOverride(choice);\n          newMetadata = { ...newMetadata, ...metadata };\n          newCredentials = { ...newCredentials, ...credentials };\n        }\n      }\n    } catch (e) {\n      throw e;\n    } finally {\n      spinner.stop();\n    }\n    return {\n      newCredentials,\n      newMetadata,\n    };\n  }\n\n  async _chooseDistCert(username, teamId) {\n    const certs = await Credentials.getExistingDistCerts(username, teamId);\n    if (certs.length > 0) {\n      const choices = certs.map(({ userCredentialId, certId, serialNumber, usedByApps }) => {\n        let name = `Serial number: ${serialNumber || 'unknown'}`;\n\n        if (certId) {\n          name = `${name}, Certificate ID: ${certId}`;\n        }\n\n        if (usedByApps) {\n          name = `Used in apps: ${usedByApps.join(', ')} (${name})`;\n        }\n\n        return {\n          name,\n          value: {\n            userCredentialId,\n            serialNumber,\n          },\n        };\n      });\n      choices.push({\n        name: 'No, please create a new one',\n        value: null,\n      });\n      const { distCert } = await prompt(createChooseDistCertPrompt(choices));\n      return {\n        userCredentialId: distCert && String(distCert.userCredentialId),\n        serialNumber: distCert && distCert.serialNumber,\n      };\n    } else {\n      return {};\n    }\n  }\n\n  _areCredsMissing(creds, action) {\n    const clientHas = new Set(Object.keys(creds));\n    const credsMissing = [];\n    const obligatoryCreds = clientHas.has('userCredentialId')\n      ? OBLIGATORY_CREDS_KEYS\n      : { ...OBLIGATORY_CREDS_KEYS, ...OBLIGATORY_DIST_CERT_CREDS_KEYS };\n    const obligatoryKeys = new Set(Object.keys(obligatoryCreds));\n\n    for (const k of obligatoryKeys.keys()) {\n      if (clientHas.has(k) === false) {\n        credsMissing.push(k);\n        action !== undefined && action();\n      }\n    }\n    if (credsMissing.length !== 0) {\n      log.warn(`We do not have some credentials for you, ${credsMissing}`);\n      return _.chain(credsMissing)\n        .map(k => obligatoryCreds[k])\n        .uniq()\n        .value();\n    }\n  }\n\n  async runLocalAuth(credsMetadata) {\n    let credsStarter = await Credentials.getEncryptedCredentialsForPlatformAsync(credsMetadata);\n    let clientHasAllNeededCreds = false;\n    let credsMissing;\n    if (credsStarter !== undefined) {\n      clientHasAllNeededCreds = true;\n      credsMissing = this._areCredsMissing(credsStarter, () => (clientHasAllNeededCreds = false));\n    } else {\n      credsStarter = {};\n    }\n    if (this.checkEnv()) {\n      const credentialsCI = await this.runningAsCI();\n      const creds = { ...credsStarter, ...credentialsCI };\n      this._areCredsMissing(creds);\n      await Credentials.updateCredentialsForPlatform('ios', creds, credsMetadata);\n      log.warn(\n        `Encrypted ${Object.keys(OBLIGATORY_CREDS_KEYS).join(', ')} and saved to expo servers`\n      );\n    } else if (clientHasAllNeededCreds === false) {\n      const strategy = await prompt(runAsExpertQuestion);\n      const isEnterprise = this.options.appleEnterpriseAccount !== undefined;\n      credsStarter.enterpriseAccount = isEnterprise ? 'true' : 'false';\n      const { appleCredentials, team } = await this._validateCredsEnsureAppExists(\n        credsMetadata,\n        !strategy.isExpoManaged,\n        isEnterprise\n      );\n      credsStarter = { ...credsStarter, ...team };\n      if (strategy.isExpoManaged) {\n        const { newCredentials, newMetadata } = await this.runningAsExpoManaged(\n          appleCredentials,\n          credsStarter.teamId,\n          credsMetadata,\n          isEnterprise,\n          credsMissing\n        );\n        credsStarter = { ...credsStarter, ...newCredentials };\n        credsMetadata = { ...credsMetadata, ...newMetadata };\n      } else {\n        const { newCredentials, newMetadata } = await this.runningAsExpert(credsMissing);\n        credsStarter = { ...credsStarter, ...newCredentials };\n        credsMetadata = { ...credsMetadata, ...newMetadata };\n      }\n      const { result, ...creds } = credsStarter;\n      this._areCredsMissing(creds);\n\n      const withoutEncrypted = _.pickBy(creds, v => v !== 'encrypted');\n      await Credentials.updateCredentialsForPlatform('ios', withoutEncrypted, credsMetadata);\n    } else {\n      log('Using existing credentials for this build');\n    }\n  }\n\n  _throwIfFailureWithReasonDump(replyAttempt) {\n    if (replyAttempt.result === 'failure') {\n      const { reason, rawDump } = replyAttempt;\n      throw new Error(`Reason: ${reason}, raw: ${JSON.stringify(rawDump, null, 2)}`);\n    }\n  }\n\n  async askForAppleCreds(justTeamId = false) {\n    const { appleId } = this.options;\n    const password = process.env.EXPO_APPLE_PASSWORD;\n    if (appleId && password) {\n      return {\n        appleId,\n        password,\n      };\n    }\n    if (justTeamId === false) {\n      console.log(`\nWe need your Apple ID/password to manage certificates and\nprovisioning profiles from your Apple Developer account.\n\nNote: Expo does not keep your Apple ID or your Apple password.\n    `);\n    } else {\n      console.log(`\nWe need your Apple ID/password to ensure the correct teamID and appID\n\nNote: Expo does not keep your Apple ID or your Apple password.\n    `);\n    }\n    return prompt(appleCredsQuestions);\n  }\n}\n"],"sourceRoot":"/expo-cli@2.4.0/src"}